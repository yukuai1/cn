# 数据迁移工具介绍

## 产品介绍

Redis数据传输服务RDTS（Redis Data Transmission Service）是京东云提供的Redis数据传输服务，支持全量数据迁移和增量数据迁移，可以实现在不停服的情况下，平滑地完成数据库的迁移，降低对业务的影响。

## 迁移支持场景

RDTS工具支持“全量数据迁移+增量数据迁移”：

-   全量迁移：RDTS 迁移服务支持一次性将数据迁移到云上。

-   增量迁移：通过增量数据迁移可以实现在不停服下，平滑完成数据迁移。RDTS 迁移服务支持全量迁移 + 增量同步，将数据实时同步到云上。

| 支持的源库 |  支持的目标库  |    支持的版本  | 
| :--- | :---  |  :---  | 
|  自建Redis（Standalone）| 云缓存Redis（标准版、Proxy集群版） |  2.8\3.0\3.2\4.0\5.0  | 
| 云缓存Redis（标准版、Proxy集群版）  |  云缓存Redis（标准版、Proxy集群版）  | 2.8\4.0  | 
|云缓存Redis（标准版、Proxy集群版） |自建Redis，单点接入模式（Cluster集群需要部署代理才可以支持)   | 没有限制 | 
| Cluster集群暂不支持 | / | /  | 

**注意：**

-   1、目前不支持断点续传，如果出现网络中断，需要将目标端的数据清空重新进行迁移

-   2、自建Redis需要符合Redis开源协议。

RDTS目前主要可支持3种迁移场景：

-   自建Redis迁移到云缓存Redis。支持将传统 IDC 的 Redis 、云主机自建Redis，迁移到云缓存 Redis中。

-   云缓存Redis之间的单向数据迁移。

-   跨云单向迁移。例如支持您从阿里云迁移到京东云。

对于不同的迁移场景，在配置数据迁移前，RDTS工具所需的权限有所区别，您可参考下表的迁移场景为源和目标库准备相关权限。
| 迁移场景 |  源库权限要求库  |    目标库权限要求  | 
| :--- | :---  |  :---  | 
| 同一京东云账号下，云缓存Redis实例之间的单向数据迁移，包含版本从2.8升级到4.0  | 可直接迁移或升级  |  可直接迁移或升级 | 
| 从京东云缓存Redis同步至自建Redis | 读写权限  | 读写权限 | 
| 从自建Redis迁移到京东云缓存Redis | 读写权限，允许执行SYNC或PSYNC命令 | 读写权限  | 
| 跨云单向迁移至京东云缓存Redis  | 读写权限，允许执行SYNC或PSYNC命令 |  读写权限  | 

## 迁移工作流程简

RDTS数据迁移全流程工作内容如下： 

![](../../../../image/Redis/Data-Migration-1.png)

-   准备阶段：在迁移前需要提前在控制台创建目标云缓存实例，确认数据源Redis没有使用不支持命令等工作。

-   创建任务：在RDTS控制台创建迁移任务。

-   数据迁移：该阶段将完成数据迁移，在迁移过程中RDTS将完成数据迁移和数据一致性校验。

-   业务流量切换： RDTS提供了3种流量切读策略的可视化操作功能，您可以使用RDTS代理流量业务，通过把应用流量指向RDTS的迁移代理，由RDTS帮您一键完成流量切换，然后再将应用流量指向目的集群；您也可以不使用该功能，自行操作业务的流量切换。

-   结束迁移：等待流量完全切换到目标Redis实例后，可点击迁移完成释放迁移资源。

## 迁移状态
|  状态值 |  任务状态   |    任务状态说明  | 
| :--- | :---  |  :---  | 
|  creating	   |   创建中	   |   创建manager   |   
|  validated   |   	验证通过  |   	验证通过，可进行下一步任务创建   |   
|  invalid	   |   验证失败   |   	配置验证无效，需查看配置是否正确   |   
|  starting	   |   启动中	   |   启动任务   |   
|  waitMigrate |   	待迁移	   |      |   
|  migrating   |   	迁移中    |    	   |   
|  migrated	   |   迁移成功	  |   迁移成功，可释放资源   |   
|  createFailed   | 创建失败  |   任务创建失败   |   
|  startFailed    |启动失败	  |   任务启动失败   |   
|  error	     |   异常错误	  |   如果有端存在开源Redis，请查看网络是否通、实例配置是否正确。   |   
|  migrateFailed  |迁移失败   |   	迁移失败，可重新迁移   |   
|  migrateTimeout |迁移超时   |   	迁移超时，可重新迁移   |   
|  deleting	   |   删除中	   |      |   

## 受限命令
数据同步过程中以下命令受限：
|  命令   |  说明   |  
| :--- | :---  |
|  module	   |  不支持   |  
|  migrate   |  	是redis迁移数据的命令，使用rdts，需要保证源端稳定，不能处于数据迁移过程中     |  
|  readonly  |    	让源端变成只读状态了，不能执行    |  
|  shutdown  |   	不能执行   |  


##  注意事项

1、RDTS支持向空实例中同步数据，暂时不支持往已存在数据的云缓存Redis实例中迁移数据。

2、源库的版本需要不高于目标库版本。如Redis2.8可往Redis4.0版本迁移，但是不支持从4.0往2.8迁移。如果您的开源redis存在高版本向低版本迁移时，请确定是否有低版本不支持的命令，如果有则可能在同步过程中报错。比如Redis5.0往4.0迁移时，stream相关所有命令Redis4.0并不支持，则迁移中会报错导致迁移失败。

3、RDTS暂时不支持指定数据迁移。比如将DB0的数据迁移到DB1中。

4、如果源库和目标库均为云上Redis缓存实例，则它们需在同一地域。

5、迁移权限要求：RDTS 迁移数据需要源实例支持 SYNC 或者 PSYNC 命令。

6、如果做跨云迁移、或从云下自建Redis迁移到云上，需保持网络互通。

7、对于通过EVAL或EVALSHA调用的Lua脚本，在增量数据迁移时，由于目标端在执行脚本时不会明确返回执行结果， 所以迁移系统无法确认该类型脚本是否执行成功

8、迁移过程中如果需要回滚迁移，需要注意命令支持问题：云Redis4.0默认删除过期Key是异步的方式，同步到从节点使用的是unlink命令；而Redis3.2不支持unlink命令，则会导致回迁失败。当前解决方案为，需要修改云Redis4.0参数默认值：lazyfree-lazy-expire no，因该参数暂未开放到参数修改中，请联系我们修改。

9、限制：RDTS工具目前暂时不支持断点续传，如果出现网络中断，需要将目标端的数据清空重新进行迁移。

