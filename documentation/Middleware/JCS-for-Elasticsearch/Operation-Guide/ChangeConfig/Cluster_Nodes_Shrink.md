# 缩容集群数据节点

当您的业务处于流量低峰期或集群中的数据量减小时，可通过京东云搜索 Elasticsearch 的集群降配功能，减少集群中数据节点的数量，以更好地保障业务发展并控制成本。
本文介绍了京东云 Elasticsearch 缩容集群中的数据节点的操作方法、相关说明和注意事项。

## 前提条件
- 集群为正常状态（绿色）。如果集群为非正常状态（黄色或红色），请待集群恢复正常状态（绿色）再降配集群。
- 完成集群规格容量评估。 评估方法，请参见 [规格容量评估](../../Best-Practices/Capacity-Assessment.md)。请结合规格容量评估和使用限制，确保确保降配后集群有足够的存储空间。如果降配后集群负载较高，建议及时升配，具体操作请参见 [升配集群](../ChangeConfig/Cluster_Expansion.md)。
- 检查集群中是否存在 **状态为 close 的索引**。如果存在，需要将 **对应索引的状态暂时设置为Open，否则变更不成功**。
  - 登录 Kibana 控制台，执行以下命令，查看索引状态。

  ```
  GET /_cat/indices?v
  ```
  
  - 将close状态的索引暂时设置为open状态。<index_name>需要替换为状态为close的索引名称。
  ```
  POST /<index_name>/_open
  ```
  </br>

## 使用限制
- 必须开启专有主节点。
- 预估节点数量缩容后的单节点磁盘水位，要求低于磁盘水位限制（不超过75%）。

</br>

## 注意事项

### 服务影响
- 缩容过程会涉及数据迁移，将要下线的节点数据迁移到其他节点上，缩容集群数据节点会触发集群重启，缩容过程和集群变更后重启实际时长与集群规模、数据量及负载情况等有关系，建议在低峰期操作。
- 如果集群索引存在副本分片且集群负载处于正常水平（CPU使用率在60%左右，堆内存使用率在50%左右，load_1m低于CPU核数），一般情况下，在集群重启过程中可持续对外提供服务。
- 对于多可用区实例，在变更时，需要确保集群中任意一个索引的副本数都小于可用区数。待变更完成后，您可以根据业务手动增加副本数。
- 如果集群负载过高且索引没有副本，同时在缩容过程中存在大量写入或查询等情况，在缩容过程中可能会出现访问超时的问题。建议在缩容前，在客户端中配置好重试机制，减小对业务的影响。

### 计费变化
提交了降配订单后，集群将按照更新后的订单计费。计费规则，请参见 [计费规则](../../Pricing/Billing-Rules.md)。
- 对于按配置计费实例，调整配置后将按照新规格计费，调整前规格会立即出账结算（即对上次整点结算时间至当前时间产生的费用进行结算）；
- 对于包年包月计费云主机：
  - 若调配后规格价格低于调配前规格价格，则将延长云主机到期时间；
  - 若调配后规格价格高于调配前规格价格，需要支付到期前的差价。

> 说明：在降配集群时，您可以在变配页面，实时观察更新后的订单消费金额。

</br>

## 操作步骤
1. 访问 [云搜索Elasticsearch控制台](https://es-console.jdcloud.com/clusters)，进入集群管理页面。或访问 [京东云控制台](https://console.jdcloud.com/)，点击顶部导航栏 互联网中间件-云搜索Elasticsearch，进入集群管理页。
2. 在您要变更配置的集群，选择 【**操作-更多-变更配置**】。
3. 在变更配置页面，展示了当前集群的配置信息，便于您在执行降配操作时参考。根据实际业务需求，通过页面提示选择要缩容的数据节点。</br>
选择后，京东云搜索 Elasticsearch 会对待缩容的节点进行校验。如果校验不通过，您需要根据页面提示处理异常结果，处理后再重新进行缩容操作。

| 检查项 | 正常状态 |
| :-- | :-- |
| 集群健康状态 | 集群状态正常（绿色）。|
| 缩容后，集群的剩余节点数和磁盘大小 | - 剩余节点数大于等于2。对于多可用区实例，还需确保每个可用区剩余节点数相同。</br>- 缩容后节点的磁盘使用率不超过75%。 |

</br>

![Cluster_expansion_1](../../../../../image/Elasticsearch/ChangeCfg/Cluster_expansion_1.png)

4. 确认变更配置后，点击 **变更** 按钮。
5. 在订单确认页，确认订单新和应付金额后，选中 **已阅读并同意《云搜索Elasticsearch服务条款》**，点击 **立即支付**。支付完成后，集群会重启，重启成功后即可完成集群降配。
